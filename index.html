<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Coleta Verde - Mapa</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* --- layout geral --- */
    body { margin:0; font-family: Arial, sans-serif; background:#fff; }
    header { background:#2e7d32; color:white; padding:12px; text-align:center; position:relative; }
    header h2 { margin:0; }
    #controls { padding:8px; display:flex; gap:8px; align-items:center; background:#f6fdf6; flex-wrap:wrap; }
    #map { height:87vh; width:100%; display:block; }
    .btn { padding:6px 10px; border-radius:4px; border:1px solid #ccc; cursor:pointer; background:white; }
    input[type="text"] { padding:6px; border:1px solid #ccc; border-radius:4px; }
    label { font-size:14px; }

    /* --- menu inicial (overlay simples) --- */
    #menu {
      position:fixed;
      inset:0;
      background: linear-gradient(180deg, rgba(46,125,50,0.95), rgba(16,93,28,0.95));
      color:white;
      z-index:9999;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:14px;
      padding:20px;
    }
    #menu h1 { margin:0; font-size:32px; }
    #menu p { max-width:800px; text-align:center; margin:0; opacity:0.95; }
    .menu-btn { padding:12px 20px; border-radius:8px; border:none; cursor:pointer; font-size:16px; background:white; color:#2e7d32; }
    .menu-small { background:transparent; border:1px solid rgba(255,255,255,0.2); color:white; padding:8px 12px; border-radius:6px; }

    /* --- panel de conte√∫do (sobre / como) --- */
    .panel {
      position:fixed;
      inset:10vh 10vw 10vh 10vw;
      background:white;
      color:#111;
      z-index:10000;
      padding:18px;
      border-radius:8px;
      box-shadow:0 6px 20px rgba(0,0,0,0.25);
      overflow:auto;
      display:none;
    }
    .panel h3 { margin-top:0; }
    .panel .close { float:right; cursor:pointer; background:#eee; padding:6px 8px; border-radius:6px; }

    /* --- bot√£o menu no canto dos controles --- */
    #openMenuBtn { margin-left:auto; background:#2e7d32; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; }

    /* --- estilo do marcador destacado (nearest) se necess√°rio via CSS --- */
    .nearest-icon div { box-shadow: 0 0 0 3px rgba(255,255,255,0.9); }

    /* responsividade simples */
    @media(max-width:600px){
      #controls { flex-direction:column; gap:6px; align-items:stretch; }
      .menu-btn { width:90%; }
      .panel { inset:5vh 4vw 5vh 4vw; }
    }
  </style>
</head>
<body>
  <header>
    <h2>Coleta Verde ‚Äî Pontos de Descarte</h2>
  </header>

  <!-- Menu inicial -->
  <div id="menu" role="dialog" aria-modal="true">
    <h1>Coleta Verde</h1>
    <p>Encontre pontos de descarte correto de res√≠duos em Porto Alegre. Use o mapa para localizar ecopontos pr√≥ximos ao seu CEP ou endere√ßo.</p>

    <button class="menu-btn" id="openMapBtn">Abrir mapa</button>

    <div style="display:flex;gap:10px;margin-top:6px;">
      <button class="menu-small" id="openSobreBtn">Sobre</button>
      <button class="menu-small" id="openComoBtn">Como descartar</button>
    </div>

  </div>

  <!-- Painel Sobre -->
  <div id="panelSobre" class="panel" aria-hidden="true">
    <div><span class="close" id="closeSobre">Fechar ‚úï</span></div>
    <h3>Sobre a Coleta Verde</h3>
    <p>O Coleta Verde √© um projeto que facilita a localiza√ß√£o de pontos oficiais de descarte de res√≠duos (eletr√¥nicos, pilhas, √≥leo).</p> 
    <p>O objetivo √© incentivar o descarte correto, de maneira simples, eficiente e ajudar a reduzir res√≠duos indevidos na cidade.</p>
  </div>

  <!-- Painel Como descartar -->
  <div id="panelComo" class="panel" aria-hidden="true">
    <div><span class="close" id="closeComo">Fechar ‚úï</span></div>
    <h3>Como descartar corretamente</h3>
    <ul>
      <li>Eletr√¥nicos: levar em ecopontos ou pontos de coleta espec√≠ficos ‚Äî nunca descartar no lixo comum.</li>
      <li>Pilhas e baterias: devolver em pontos de venda quando poss√≠vel ou em ecopontos espec√≠ficos.</li>
      <li>√ìleo de cozinha: guardar em garrafas e entregar em pontos que recebem √≥leo para reciclagem.</li>
    </ul>
  </div>

  <!-- Controles e mapa -->
  <div id="controls">
    <!-- CEP obrigat√≥rio -->
    <label for="cep">CEP (obrigat√≥rio):</label>
    <input type="text" id="cep" placeholder="Ex: 90010-000" />
    <button class="btn" id="buscarCEP">Buscar CEP</button>

    <!-- Endere√ßo manual opcional -->
    <label for="address">Endere√ßo (opcional):</label>
    <input type="text" id="address" placeholder="Ex: Rua dos Andradas, 1000" disabled />
    <button class="btn" id="buscarAddress" disabled>Buscar Endere√ßo</button>

    <!-- Filtro por tipo -->
    <label>Filtro:</label>

    <!-- üîß ALTERA√á√ÉO AQUI ‚Äî apenas estas 3 linhas -->
    <select id="filter" onchange="aplicarFiltro()">
      <option value="">Todos</option>
      <option value="Eletr√¥nicos">Eletr√¥nicos</option>
      <option value="Pilhas/Baterias">Pilhas/Baterias</option>
    </select>
    <!-- fim da altera√ß√£o -->

    <button class="btn" onclick="centralizarLocalizacao()">Ir para minha localiza√ß√£o</button>

    <!-- bot√£o menu -->
    <button id="openMenuBtn" title="Menu">Menu</button>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>

    /* -------------------------
       Vari√°veis iniciais/estado
       ------------------------- */
    const boundsSW = [-30.30, -51.35];
    const boundsNE = [-29.85, -51.05];
    const bounds = L.latLngBounds(L.latLng(boundsSW[0], boundsSW[1]), L.latLng(boundsNE[0], boundsNE[1]));

    const map = L.map('map', {
      maxBounds: bounds,
      maxBoundsViscosity: 1.0,
      minZoom: 11,
      maxZoom: 19
    }).setView([-30.0346, -51.2177], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);

    let cepValidado = false;
    let lastGeocodedLat = null;
    let lastGeocodedLon = null;
    let userPositionMarker = null;
    let nearestHighlightMarker = null;

    /* -------------------------
       Fun√ß√µes do menu
       ------------------------- */
    const menu = document.getElementById('menu');
    const openMapBtn = document.getElementById('openMapBtn');
    const openSobreBtn = document.getElementById('openSobreBtn');
    const openComoBtn = document.getElementById('openComoBtn');
    const panelSobre = document.getElementById('panelSobre');
    const panelComo = document.getElementById('panelComo');
    const closeSobre = document.getElementById('closeSobre');
    const closeComo = document.getElementById('closeComo');
    const openMenuBtn = document.getElementById('openMenuBtn');

    openMapBtn.addEventListener('click', () => {
      menu.style.display = 'none';
      setTimeout(()=> map.invalidateSize(), 300);
    });

    openSobreBtn.addEventListener('click', () => {
      panelSobre.style.display = 'block';
      panelSobre.setAttribute('aria-hidden','false');
    });
    openComoBtn.addEventListener('click', () => {
      panelComo.style.display = 'block';
      panelComo.setAttribute('aria-hidden','false');
    });
    closeSobre.addEventListener('click', () => {
      panelSobre.style.display='none';
      panelSobre.setAttribute('aria-hidden','true');
    });
    closeComo.addEventListener('click', () => {
      panelComo.style.display='none';
      panelComo.setAttribute('aria-hidden','true');
    });

    openMenuBtn.addEventListener('click', () => {
      menu.style.display = 'flex';
      panelSobre.style.display='none';
      panelComo.style.display='none';
    });

    /* -------------------------
       Carregar pontos
       ------------------------- */
    function carregarPontos(wasteType = '') {
      const url = wasteType ? `/points?waste_type=${encodeURIComponent(wasteType)}` : '/points';
      fetch(url).then(r => r.json()).then(points => {
        markersLayer.clearLayers();
        points.forEach(p => {
          const lat = parseFloat(p.latitude);
          const lon = parseFloat(p.longitude);
          if (!isNaN(lat) && !isNaN(lon)) {
            const m = L.marker([lat, lon]).bindPopup(`<b>${p.name}</b><br>${p.address}<br><i>${p.waste_type}</i>`);
            markersLayer.addLayer(m);
          }
        });
      }).catch(err => console.error('Erro ao carregar pontos:', err));
    }
    carregarPontos();

    function aplicarFiltro() {
      const val = document.getElementById('filter').value;
      carregarPontos(val);
    }

    /* -------------------------
       Haversine
       ------------------------- */
    function haversineKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    /* -------------------------
       Encontrar mais pr√≥ximo
       ------------------------- */
    async function encontrarEMostrarMaisProximo() {
      if (!cepValidado || lastGeocodedLat === null || lastGeocodedLon === null) return;

      const tipo = document.getElementById('filter').value || '';
      const url = tipo ? `/points?waste_type=${encodeURIComponent(tipo)}` : '/points';

      try {
        const resp = await fetch(url);
        if (!resp.ok) return;
        const pontos = await resp.json();

        let maisProximo = null;
        let menorDist = Infinity;

        pontos.forEach(p => {
          const plat = parseFloat(p.latitude);
          const plon = parseFloat(p.longitude);
          if (isNaN(plat) || isNaN(plon)) return;
          const d = haversineKm(lastGeocodedLat, lastGeocodedLon, plat, plon);
          if (d < menorDist) { menorDist = d; maisProximo = p; }
        });

        if (!maisProximo) return;

        if (nearestHighlightMarker) { nearestHighlightMarker.remove(); nearestHighlightMarker = null; }

        const highlightIcon = L.divIcon({
          className: 'nearest-icon',
          html: `<div style="background:#2e7d32;border:3px solid white;border-radius:18px;width:36px;height:36px;"></div>`,
          iconSize: [36,36],
          iconAnchor: [18,36]
        });

        nearestHighlightMarker = L.marker([maisProximo.latitude, maisProximo.longitude], {icon: highlightIcon}).addTo(map);

        const distanciaTexto = `${menorDist.toFixed(2)} km`;

        nearestHighlightMarker.bindPopup(
          `<b>${maisProximo.name}</b><br>${maisProximo.address}<br><i>${maisProximo.waste_type}</i><br><b>Dist√¢ncia:</b> ${distanciaTexto}<br><a target="_blank" href="https://www.google.com/maps/dir/?api=1&origin=${lastGeocodedLat},${lastGeocodedLon}&destination=${maisProximo.latitude},${maisProximo.longitude}">Ver rota</a>`
        ).openPopup();

        map.setView([maisProximo.latitude, maisProximo.longitude], 14);

      } catch (err) {
        console.error('Erro ao calcular ponto mais pr√≥ximo:', err);
      }
    }

    /* -------------------------
       CEP
       ------------------------- */
    document.getElementById('buscarCEP').addEventListener('click', async () => {
      const cep = document.getElementById('cep').value.trim();
      if (!cep) { alert('Por favor informe um CEP.'); return; }

      cepValidado = false;
      lastGeocodedLat = null;
      lastGeocodedLon = null;
      if (userPositionMarker) { userPositionMarker.remove(); userPositionMarker = null; }
      if (nearestHighlightMarker) { nearestHighlightMarker.remove(); nearestHighlightMarker = null; }

      document.getElementById('address').value = '';
      document.getElementById('address').disabled = true;
      document.getElementById('buscarAddress').disabled = true;

      try {
        const r = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await r.json();
        if (data.erro) { alert('CEP n√£o encontrado.'); return; }

        const enderecoCompleto = `${data.logradouro || ''} ${data.bairro || ''} Porto Alegre`.trim();

        const searchResp = await fetch(`/search?q=${encodeURIComponent(enderecoCompleto)}`);
        const resJson = await searchResp.json();

        if (!resJson || resJson.error || resJson.length === 0) {
          alert('N√£o foi poss√≠vel geocodificar o CEP. Use endere√ßo manual.');
          document.getElementById('address').disabled = false;
          document.getElementById('buscarAddress').disabled = false;
          return;
        }

        const lat = parseFloat(resJson[0].lat);
        const lon = parseFloat(resJson[0].lon);

        map.setView([lat, lon], 15);
        userPositionMarker = L.circleMarker([lat, lon], {radius:8, color:'#2e7d32', fillColor:'#2e7d32', fillOpacity:0.8}).addTo(map).bindPopup("Sua posi√ß√£o aproximada").openPopup();

        cepValidado = true;
        lastGeocodedLat = lat;
        lastGeocodedLon = lon;

        document.getElementById('address').disabled = false;
        document.getElementById('buscarAddress').disabled = false;

        encontrarEMostrarMaisProximo();

      } catch (err) {
        console.error(err);
        alert('Erro ao buscar CEP.');
      }
    });

    /* -------------------------
       Endere√ßo manual
       ------------------------- */
    document.getElementById('buscarAddress').addEventListener('click', async () => {
      if (!cepValidado) {
        alert('Informe seu CEP primeiro.');
        return;
      }
      const q = document.getElementById('address').value.trim();
      if (!q) { alert('Digite um endere√ßo.'); return; }

      try {
        const resp = await fetch(`/search?q=${encodeURIComponent(q + ' Porto Alegre')}`);
        const resJson = await resp.json();

        if (!resJson || resJson.error || resJson.length === 0) {
          alert('Endere√ßo n√£o encontrado.');
          return;
        }

        const lat = parseFloat(resJson[0].lat);
        const lon = parseFloat(resJson[0].lon);

        if (userPositionMarker) { userPositionMarker.remove(); userPositionMarker = null; }
        userPositionMarker = L.circleMarker([lat, lon], {radius:8, color:'#2e7d32', fillColor:'#2e7d32', fillOpacity:0.8}).addTo(map).bindPopup("Sua posi√ß√£o aproximada").openPopup();

        lastGeocodedLat = lat;
        lastGeocodedLon = lon;

        map.setView([lat, lon], 15);

        encontrarEMostrarMaisProximo();

      } catch (err) {
        console.error(err);
        alert('Erro na busca de endere√ßo.');
      }
    });

    /* -------------------------
       Geolocaliza√ß√£o
       ------------------------- */
    function centralizarLocalizacao() {
      if (!navigator.geolocation) {
        alert('Geolocaliza√ß√£o n√£o suportada.');
        return;
      }
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        if (!bounds.contains([lat, lon])) {
          alert('Fora da √°rea de Porto Alegre.');
          return;
        }

        if (userPositionMarker) { userPositionMarker.remove(); userPositionMarker = null; }
        userPositionMarker = L.circleMarker([lat, lon], {radius:8, color:'#2e7d32', fillColor:'#2e7d32', fillOpacity:0.8}).addTo(map).bindPopup("Sua posi√ß√£o aproximada").openPopup();

        lastGeocodedLat = lat;
        lastGeocodedLon = lon;

        map.setView([lat, lon], 14);

        encontrarEMostrarMaisProximo();

      }, err => {
        alert('Erro na localiza√ß√£o: ' + err.message);
      });
    }

    /* -------------------------
       Ajuste inicial do mapa
       ------------------------- */
    setTimeout(()=> map.invalidateSize(), 300);

  </script>
</body>
</html>
